<!DOCTYPE html>
<html>
<style>
table, th, td {
  border:1px solid black;
}
</style>
<body>

<h2>Employees</h2>

<form>
<table style="width:100%">
  <thead>
    <tr>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Hire Date</th>
      <th>Role</th>
      <th>ID</th>
    </tr>
  </thead>
  <tbody id="employeeTableBody"></tbody>
</table>
<button id="submitChangesButton" type="button">Submit Changes</button>
<button>New Record</button>
</form>

</body>
<script>
  const employeeTable = document.getElementById("employeeTableBody");
  const submitChangesButton= document.getElementById("submitChangesButton");

  function deleteButtonClicked(employeeId) {
    fetch(`/api/employees/${employeeId}`, {
      method:'DELETE'
    })
            .then(_ => updateEmployeeTable())
            // TODO verify success
            .catch(e => console.log(e));
  }

  function populateEmployeeTable(employeeList) {

    employeeTable.innerHTML = '';

    employeeList.forEach(employee => {
      let row = employeeTable.insertRow();
      let fnameCell = row.insertCell();
      fnameCell.innerHTML = `<input type="text" value=${employee.fname}>`;
      let lnameCell = row.insertCell();
      lnameCell.innerHTML = `<input type="text" value=${employee.lname}>`;
      let hdateCell = row.insertCell();
      hdateCell.innerHTML = `<input type="text" value=${employee.hdate}>`;
      let roleCell = row.insertCell();
      roleCell.innerHTML = `<input type="text" value=${employee.role}>`;
      let idCell = row.insertCell();
      idCell.innerHTML = `<input type="text" value=${employee.id}>`;
      let deleteCell = row.insertCell();
      deleteCell.innerHTML = `<button onclick="deleteButtonClicked(${employee.id})">Delete</button>`;
    });
  }

  function updateEmployeeTable() {
    fetch('/api/employees', {
      method:'GET',
      headers: {'Accept': 'application/json'}})
            .then(response => response.json())
            .then(employees => populateEmployeeTable(employees));
  }

  function submitButtonClicked() {
    for (let row of employeeTable.rows) {
      cells = row.cells;
      fname = cells[0].firstChild.value;
      lname = cells[1].firstChild.value;
      hdate = cells[2].firstChild.value;
      role = cells[3].firstChild.value;
      id = cells[4].firstChild.value;

      // TODO validate inputs

      let employee = {
        "fname": fname,
        "lname": lname,
        "hdate": hdate,
        "role": role,
        "id": id
      }

      fetch(`/api/employees/${id}`, {
        method:'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(employee)})
              .then(_ => updateEmployeeTable())
              // TODO verify success on all PUTs
              // TODO wait for all PUTs before updating table
              .catch(e => console.log(e));
    }
  }

  submitChangesButton.addEventListener("click", submitButtonClicked);

  updateEmployeeTable();

</script>
</html>
