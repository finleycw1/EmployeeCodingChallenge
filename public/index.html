<!DOCTYPE html>
<html>
<head>
    <title>Employees</title>
    <style>
        table, th, td {
            border: 1px solid black;
        }
    </style>
</head>
<body>

<h2>Employees</h2>

<form>
    <table style="width:100%">
        <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Hire Date</th>
            <th>Role</th>
            <th>ID</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody"></tbody>
    </table>
    <button id="submitChangesButton" type="button">Submit Changes</button>
</form>

<form>
    <h2>Add New Employee</h2>
    <table style="width:100%">
        <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Hire Date</th>
            <th>Role</th>
        </tr>
        <tr>
            <td><input id="newEmployeeFirstName" type="text" value=""></td>
            <td><input id="newEmployeeLastName" type="text" value=""></td>
            <!-- TODO Use a date-picker -->
            <td><input id="newEmployeeHireDate" type="text" value=""></td>
            <td>
                <select id="newEmployeeRole" name="role">
                    <option value="CEO">CEO</option>
                    <option value="VP">VP</option>
                    <option value="Manager">Manager</option>
                    <option value="Lackey">Lackey</option>
                </select>
            </td>
        </tr>
        </thead>
        <tbody id="newRecordTableBody"></tbody>
    </table>
    <button id="newRecordButton" type="button">New Record</button>
</form>

<p id="errorMessages" style="color:red">

</body>
<script>
    const employeeTable = document.getElementById("employeeTableBody");
    const errorMessages = document.getElementById("errorMessages");

    const submitChangesButton = document.getElementById("submitChangesButton");
    const newRecordButton = document.getElementById("newRecordButton");

    function populateEmployeeTable(employeeList) {

        employeeTable.innerHTML = '';

        // TODO sort these (maybe by ID number?)
        employeeList.forEach(employee => {
            let row = employeeTable.insertRow();
            let fnameCell = row.insertCell();
            fnameCell.innerHTML = `<input type="text" value=${employee.fname}>`;
            let lnameCell = row.insertCell();
            lnameCell.innerHTML = `<input type="text" value=${employee.lname}>`;
            let hdateCell = row.insertCell();
            hdateCell.innerHTML = `<input type="text" value=${employee.hdate}>`;
            let roleCell = row.insertCell();
            // TODO make this a select like the new employee (It wasn't obvious how to set a default option from here)
            roleCell.innerHTML = `<input type="text" value=${employee.role}>`;
            let idCell = row.insertCell();
            idCell.innerText = employee.id;
            let deleteCell = row.insertCell();
            deleteCell.innerHTML = `<button onclick="deleteButtonClicked(${employee.id})">Delete</button>`;
        });
    }

    function updateEmployeeTable() {
        fetch('/api/employees', {
            method: 'GET',
            headers: {'Accept': 'application/json'}
        })
            .then(response => {
                if (response.ok) {
                    errorMessages.innerText = "";
                    let employees = response.json();
                    return employees;
                }
                else {
                    errorMessages.innerText = response.statusText;
                }
            })
            .then(employees => populateEmployeeTable(employees));
    }

    function deleteButtonClicked(employeeId) {
        fetch(`/api/employees/${employeeId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    errorMessages.innerText = "";
                    updateEmployeeTable()
                }
                else {
                    errorMessages.innerText = response.statusText;
                }
            });
    }

    function submitButtonClicked() {

        let requests = []

        for (let row of employeeTable.rows) {
            cells = row.cells;
            fname = cells[0].firstChild.value;
            lname = cells[1].firstChild.value;
            hdate = cells[2].firstChild.value;
            role = cells[3].firstChild.value;
            id = cells[4].innerText;
            // TODO validate inputs client-side

            let employee = {
                "fname": fname,
                "lname": lname,
                "hdate": hdate,
                "role": role,
                "id": id
            };

            // TODO only PUT rows that have changed
            requests = [...requests,
                fetch(`/api/employees/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(employee)
                })
            ];
        }

        // Wait for all PUTs to complete, then print any error messages and update table
        Promise.all(requests)
            .then(values => {
                values.filter(response => !response.ok).forEach(response => {errorMessages.innerText += response.error});
                updateEmployeeTable();
            })
    }

    submitChangesButton.addEventListener("click", submitButtonClicked);

    function newRecordButtonClicked() {

        const newEmployeeFirstName = document.getElementById("newEmployeeFirstName");
        const newEmployeeLastName = document.getElementById("newEmployeeLastName");
        const newEmployeeHireDate = document.getElementById("newEmployeeHireDate");
        const newEmployeeRole = document.getElementById("newEmployeeRole");

        // TODO validate inputs client-side

        let employee = {
            "fname": newEmployeeFirstName.value,
            "lname": newEmployeeLastName.value,
            "hdate": newEmployeeHireDate.value,
            "role": newEmployeeRole.value,
        };

        fetch(`/api/employees`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(employee)
        })
            .then(response => {
                if (response.ok) {
                    errorMessages.innerText = "";
                    updateEmployeeTable();
                    // Clear new employee form
                    newEmployeeFirstName.value = "";
                    newEmployeeLastName.value = "";
                    newEmployeeHireDate.value = "";
                }
                else {
                    errorMessages.innerText = response.statusText;
                }
            });
    }

    newRecordButton.addEventListener("click", newRecordButtonClicked);

    // Initial population of table
    updateEmployeeTable();

</script>
</html>
